---
title: 数据库操作
date: 2019-07-01 23:14:16
tags: 
category: tornado
---
tornado 数据库操作

<!-- more -->

# 实例

分为三部分：

1. RequestHandler (视图处理函数，也就是逻辑处理函数)
2. models (数据库表定义，及其他一些函数）
3. routes (路由)

## RequestHandler

```python
from tornado.web import RequestHandler
from tornado_sqlalchemy import SessionMixin,as_future
from blog.models import User

# 注册函数
class RegisterRequestHandler(SessionMixin, RequestHandler):
    # get 请求，渲染页面 
    def get(self):
        return self.render("auth/register.html")
    # post 请求，处理注册
    def post(self):
        username = self.get_argument('username')
        password = self.get_argument('password')
				# 取得数据库session 进行操作
        with self.make_session() as session:
            user = User(username=username)
            user.set_password(password)
            session.add(user)
            session.commit()
				# 返回
        self.write("register success! username:{},pasword{}".format(username,password))
# 登录函数
class LoginRequestHandler(SessionMixin, RequestHandler):
    def get(self):
        return self.render('auth/login.html')

    def post(self):
        username = self.get_argument("username")
        password = self.get_argument("password")
    		# 取得数据库session 进行操作
        with self.make_session() as session:
            # 异步取得数据，其实没什么意义
            # user = await as_future(session.query(User).filter_by(username=username).first)
            # 直接使用 sqlalchemy 来进行查询
            user = session.query(User).filter_by(username=username).first()
            if user:
                # 定义在数据库里面的函数
                if user.check_password(password):
                    self.finish({"message":"success","username":user.username})
            else:
                self.write("Sorry! You are not auth!") 
# 用户信息函数
class UserInfoRequestHandler(SessionMixin,RequestHandler):
    async def get(self):
        username = self.get_argument('user')
        with self.make_session() as session:
            user = await as_future(session.query(User).filter_by(username=username).first)
            self.render('auth/user.html',username=user.username)
```

## models

```python
# coding: utf-8 
# this is models for this app
from sqlalchemy import BigInteger, Column, String
from tornado_sqlalchemy import declarative_base
import hashlib

DeclarativeBase = declarative_base()

class User(DeclarativeBase):
    __tablename__='users'
    id = Column(BigInteger, primary_key=True)
    username = Column(String(255), unique=True)
    passwd_hash = Column(String(250))

    def set_password(self,password):
        h = hashlib.md5()
        h.update(password.encode(encoding='utf-8'))
        self.passwd_hash = h.hexdigest()

    def check_password(self, password):
        h = hashlib.md5()
        h.update(password.encode(encoding='utf-8'))
        if h.hexdigest() == self.passwd_hash:
            return True
        else:
            return False
```

## routes

