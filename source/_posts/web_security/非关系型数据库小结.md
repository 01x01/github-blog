---
title: 非关系型数据库小结
date: 2019-07-17 16:16:24
tags: 
category: websec
---
mongoDB
<!-- more -->
# 概念
SQL术语| MongoDB术语 | 解释
---|---|---
database|database| 数据库
table|collection| 数据库表/集合
row	|document| 数据记录行/文档
column|	field| 数据字段/域
index|index |索引
table|joins | 表连接,MongoDB不支持
primary key| primary key|主键,MongoDB自动将_id字段设置为主键
# 安装
```
docker run --name mongodb -p 28018:27017 -v /data/mongodb/configdb:/data/configdb/ -v /data/mongodb/db/:/data/db/ -d mongo --auth
```
# 用户和权限管理
## 添加用户管理员
```
db.createUser({ user: '<username>', pwd: '<password>', roles: [ { role: "userAdminAnyDatabase", db: "admin" } ] });
```

## 数据库角色
### 数据库用户角色
1. read: 允许用户读取指定数据库
2. readWrite: 允许用户读写指定数据库

### 数据库管理角色
1. dbAdmin： 允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile
2. dbOwner： 结合了 readWrite / dbAdmin / userAdmin 的权限
3. userAdmin： 数据库的用户管理

### 集群管理角色
1. clusterAdmin:只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限
2. clusterManager
3. clusterMonitor
4. hostManage

### 所有数据库角色
只在 admin 数据库中定义
1. readAnyDatabase:只在admin数据库中可用，赋予用户所有数据库的读权限
2. readWriteAnyDatabase:只在admin数据库中可用，赋予用户所有数据库的读写权限
3. userAdminAnyDatabase:只在admin数据库中可用，赋予用户所有数据库的userAdmin权限
4. dbAdminAnyDatabase:只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。

### 超级管理员
1. root:只在admin数据库中可用。超级账号，超级权限

### 内部角色
1. __system

## 新增数据库并且添加用户
需要注意的是，需要先登陆 admin ，认证获取新增用户权限，然后切换数据库，再新建用户
```
docker exec -it f51a mongo admin
db.auth('useradmin','useradminpasswd')
use blog
# 应该按照权限最小化原则，尽量细分用户
db.createUser({ user: '<username>', pwd: '<password>', roles: [ { role: "read", db: "blog" } ] });
db.createUser({ user: '<username>', pwd: '<password>', roles: [ { role: "readWrite", db: "blog" } ] });
db.createUser({ user: '<username>', pwd: '<password>', roles: [ { role: "userAdmin", db: "blog" } ] });
```
## 更改用户密码
```
# 注意， 只有 userAdmin 角色才能更改密码
db.changeUserPassword("username", "xxx")
```
## 更改用户信息
```
db.runCommand(
    {
        updateUser:"username",
        pwd:"xxx",
        customData:{title:"xxx"}
    }
)

db.updateUser("reader",{pwd:"reader@2019",roles:[{role:'reader',db:'testdb'}]})

```
## 删除用户
```
db.dropUser('user001')
```

## 追加权限
```
db.grantRolesToUser("testRead",[{role:"readWrite",db:"test"}])
```
# 数据库操作
## 创建数据库
```shell
use <database_name>
```
## 创建数据库表
```shell
db.createCollection("<table_name>")
# 查询几张表
show tables
```
## 插入数据
```
db.<collection_name>.insert({"key":"value"})
```
## 更新数据
*参数*
1. query : update的查询条件，类似sql update查询内where后面的。
2. update : update的对象和一些更新的操作符（如$,$inc...）等，也可以理解为sql update查询内set后面的
3. upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。
4. multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。
5. writeConcern :可选，抛出异常的级别。
```
db.collection.update(
   <query>,
   <update>,
   {
     upsert: <boolean>,
     multi: <boolean>,
     writeConcern: <document>
   }
)

db.collection.update({'name':"xiaoming"},{$set:{"name":"jack"}},{multi:true})
```
## 查询
mongo SQL | SQL 语句 | 描述
--- | --- | ---
`db.student.find({},{_id:0,name:1,scope:1})` | `select name, scope from student` | 查询名字和分数
`db.student.find()` | `select * from student` | 查询所有的数据
`db.student.find({"name":"xiaoming"})` | `select * from student where name="xiaoming"`| 条件查询
`db.student.find({"scope":{"$gte":80,"$lte":100}})`|`select * from student where scope >= 80 and scope <= 100` | 大于等于 and 小于等于
`db.student.find({"scope":{"$gt":80,"$lt":100}})`|`select * from student where scope > 80 and scope < 100` | 大于 and 小于
`db.student.find({"scope":{"$in":[80,100,90]}})`| `select * from student where scope in [80,100,90]` | in 操作
`db.student.find({"scope":{"$nin":[80,100,90]}})`| `select * from student where scope in [80,100,90]` | not in 操作
`db.student.find({"name":/[a-z]iaoming/})`| `select * from student where name like "[a-z]iaoming" `| 模糊查询
`db.students.find({"$where":"this.scope * this.age == 1440"}) ` | null | 可以用于javascript 函数，但是 `$where` 针对的是 `document` 对象
`db.student.find().sort({'scope':1}).limit(3).skip(2)` | null | 按照 scope 进行升序排序，限制显示 3 条，跳过最前面查询出来的两条

## 聚合
聚合操作主要针对的是 pipline 的表达式，分为以下几种
### 算式表达式运算符
name | description | example
--- | --- | ---
$abs|返回绝对值 | `db.student.aggregate([{$project:{_id:0,scope:{$abs:"$scope"}}}])`
$add| 返回两数相加的结果 | `db.student.aggregate([{$project:{_id:0, scope: {$add: ["$scope",2]}}}])`
$pow| 指数乘法 | `db.student.aggregate([{$project:{_id:0,scope:{$pow:["$scope",2]}}}])`
$ceil| 四舍五入，向上取整|`db.student.aggregate([{$project:{_id:0,scope:{$ceil:"$scope"}}}])`
$floor| 四舍五入，向下取整|`db.student.aggregate([{$project:{_id:0,scope:{$floor:"$scope"}}}])`

### 数组表达式操作


### 





# 参考
1. 用户权限管理：https://www.luoruiyuan.cn/pages/id-84_uid-2_btid-20.html
2. 聚合参数：https://docs.mongodb.com/manual/meta/aggregation-quick-reference/